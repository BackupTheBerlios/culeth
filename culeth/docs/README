*******************************************************************************

CULeth
(c) 2009 Dr. Boris Neubert   omega@online.de
http://developer.berlios.de/projects/culeth

*******************************************************************************



Rationale
=========

CULeth is intended to make CUL an ethernet hub. CUL is to pass ethernet II
frames between a PC and CC11xx transceiver based devices such as Betty with Boop
firmware (see http://www.bettyhacks.com).

On USB, CUL appears on the host as an ethernet adapter with a proper IP address.
The IP address is 192.168.108.1. This is the host's IP address.

Packages from the host with a destination in the subnet 192.168.108.0/255.0.0.0
pass through that interface and are transmitted to air. Packages from the air are
sent via the CUL interface to the host. CUL is completely agnostic of the higher
level protocols used in the ethernet frames it passes from Betty to host hither
and yon.

CULeth simulates a simple host (CULServer) with the following features:
- answer ARP requests
- support ICMP ping echos
- reply to UDP requests on port 7073

A command set for testing CULeth is implemented in the CULServer.


+-----------+             +--------------------+      +----------------+
| Betty 1   |    on air   |                    |      |      host      |
| x.x.x.x   |- - - - - - -|         hub        |------| 192.168.108.1  |
|           |             |                    |      |      usb0      |
+-----------+             +----------+---------+      +----------------+
                                     |
                                     |
                                +----+----------+
                                |  CULServer    |
                                |192.168.108.127|
                                |               |
                                +---------------+


***** IMPORTANT NOTICE: the current version of CULeth wraps packages received
on air into UDP packets and sends them to port 7073 on host 192.168.108.1. They
packets can be monitored by means of the tools/server.pl (see below).


CULeth is a derivative of the RNDISEthernet demo from LUFA (see
http://www.fourwalledcubicle.com/LUFA.php).


Install / Flash the firmware
============================

1. Change into the source directory
2. Insert the USB stick while pressing the micro-switch. Release the micro-switch
   one or two seconds after having inserted the USB stick.

   A USB device "03eb:2ffa Atmel Corp." should appear.

    dfu-programmer at90usb162 erase
    dfu-programmer at90usb162 flash CULeth.hex
    Validating...
    6312 bytes used (51.37%)
    dfu-programmer at90usb162 start

  The last command will reset the device, a new USB device should appear:
  "03eb:204c Atmel Corp."


For convenience, the above command sequence is scripted in the executable
tools/flash.

If all is fine, the logs will show a new usb device (use dmesg):

usb 1-9: new full speed USB device using ohci_hcd and address 98
usb 1-9: configuration #1 chosen from 1 choice
rndis_host 1-9:1.0: dev can't take 144 byte packets (max 144), adjusting MTU to 86
rndis_host 1-9:1.0: RNDIS_MSG_QUERY(0x00010202) failed, -47
usb0: register 'rndis_host' at usb-0000:00:0b.0-9, RNDIS device, 02:00:02:00:02:00
usb 1-9: New USB device found, idVendor=03eb, idProduct=204c
usb 1-9: New USB device strings: Mfr=1, Product=2, SerialNumber=0
usb 1-9: Product: CULeth RNDIS CDC
usb 1-9: Manufacturer: busware.de



Usage of CULeth
===============

Interface setup
---------------

ifconfig usb0 192.168.108.1 up
ping 192.168.108.127

Packet sniffing:
tcpdump -e -i usb0 -n -U -v -s 200 -X


CULserver communication
-----------------------

Use tools/udp.pl to talk to the CULserver. The user interface is self-explanatory.

Use tools/server.pl to listen to incoming requests from the CULserver on the
host.

The (8) test feature sends a test message to the host (4 bytes time stamp first).
Every packet that runs through the hub sends a notice to the host (4 bytes time
stamp followed by the number of the source and destination interfaces, see
Interfaces.h).



Listening to CULeth
===================

See http://developer.berlios.de/projects/culfw/ for detail on culfw!

Use a second CUL and put culfw on it. Try the following commands:

(1) tune CUL to 433.249 MHz:
W0F10
W10A9
W11D6

Fcarrier= Value * 26MHz/65536 => 433.249 MHz corresponds to 10A9D6

unplug/plug CUL to activate the setting!

(2) listen
X09





CULeth internals
================

The main function is in CULeth.c. The hub function is Ethernet_Task. It receives
a packet from an interface and forwards it on air, to the CULServer or both
(broadcasts).

Due to the small memory (512 bytes of RAM), the packet length (MTU) is quite
limited. Packets cannot be stored. Only one packet at a time, either incoming or
outgoing, can be handled.

If a message passing through the hub triggers an extra packet to be sent out,
then this is done in extras.c.


RNDIS.h		ADAPTER_MAC_ADDRESS	HWaddr 02:00:02:00:02:00 (reverse notation!)
Ethernet.h	SERVER_MAC_ADDRESS	HWAddr 01:00:01:00:01:00 (reverse notation!)
IP.h		SERVER_IP_ADDRESS	192.168.108.127





Tips & Tricks
=============
openSuSE 11.x:

If you want to program CUL without the need to become root, add new file

69-cul.rules

in the directory /etc/udev/rules.d/ with the following contents:

SYSFS{idVendor}=="03eb", SYSFS{idProduct}=="2ffa", BUS=="usb", MODE="0666"
